---
title: "Approaching the Hot Hand with a Cool Head"
output: html_notebook
---

# The Dataset

The following piece of script needs the precalculated datasets placed in the same directory.The dataset is downloadable from the file sharing service detailed in the README.md file or recreated following the steps there.

The script below does a bunch of calculations on all the input files:
  * Creates lead quantities, so we know the outcome and behaviour of the next bet
  * Create user aggregates, like balance, total sum ammount, total win ammount
  * Calculates absolute and relative changes of game descriptiors between consequent games
  * Labels and calculates game streaks (winning/losing) length and extent
  * Prepares scaled version of the prepared quantities (mostly only centered)
  
Important quantities created (for this article that is):
  * time_bet - unixtime of the bet transaction (timestamp of the block)
  * bet_value - transformed from bet ammount in satoshi to bitcoin (1 satoshi = 1e-8 BTC)
  * streak - length of streak (win/loss) 0 signs that the outcome is different from the previous game's
  * label - identifier of the sample, check the bitcoin_pricehistory_lowvar.R script for details
  * pwin - implied probability of winning (0-100), set from the scraped data, defined using the address the bet has been sent to
  * status_pred - status of the next game played 
  * pwin_pred - pwin of the following game
  * game_changed - logical variable, TRUE if a different game (pwin/odds/mulitplier) have been bet on after the current game

```{r echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE, comment=FALSE, warning=FALSE}
require(groundhog)
groundhog.day="2021-03-01"
pkgs=c('tidyverse','ggpubr')
groundhog.library(pkgs, groundhog.day)

WORKDIR <- "C:/Users/sampa/Documents/bce-bitluck" #set this for your own working directory
#WORKDIR <- "/Users/sandorm/bce-bitluck" #set this for your own working directory

normalizeToBitcoin <- function(user_bets){
  user_bets %>% 
    mutate(bet_value = bet_value * 1e-8,
           answer_value = answer_value * 1e-8)
}

aggregateUser <- function(user_bets){
  user_bets %>% 
    mutate(last_outcome = answer_value - bet_value,
           win_answer_value = ifelse(status == "win",answer_value - bet_value,0),
           loose_answer_value = ifelse(status == "loss",answer_value - bet_value,0)) %>%
    mutate(balance = cumsum(answer_value - bet_value),
           winsum = cumsum(win_answer_value),
           loosesum = cumsum(loose_answer_value))
  
}

addlag <- function(user_bets){
  user_bets %>% 
    mutate(bet_pred = lead(bet_value, n = 1),
           game_pred = lead(odds, n = 1),
           time_nextbet = lead(time_bet, n = 1),
           status_pred = lead(status, n = 1))
}
# gametable mined from https://web.archive.org/web/20130403062213/http://www.satoshidice.com/
pwin_to_prob <- c(
  "lessthan","64000","1dice9wVtrKZTBbAZqz1XiTmboYyvpD3t","97.6563","1.004","1.900","98.100","0.0010","250.0000",
  "lessthan","60000","1diceDCd27Cc22HV3qPNZKwGnZ8QwhLTc","91.5527","1.071","1.900","98.100","0.0010","250.0000",
  "lessthan","56000","1dicegEArYHgbwQZhvr5G9Ah2s7SFuW1y","85.4492","1.147","1.900","98.100","0.0010","250.0000",
  "lessthan","52000","1dicec9k7KpmQaA8Uc8aCCxfWnwEWzpXE","79.3457","1.235","1.900","98.100","0.0010","250.0000",
  "lessthan","48000","1dice9wcMu5hLF4g81u8nioL5mmSHTApw","73.2422","1.338","1.900","98.100","0.0010","250.0000",
  "lessthan","32768","1dice97ECuByXAvqXpaYzSaQuPVvrtmz6","50.0000","1.957","1.900","98.100","0.0010","250.0000",
  "lessthan","32000","1dice8EMZmqKvrGE4Qc9bUFf9PX3xaYDp","48.8281","2.004","1.900","98.100","0.0010","250.0000",
  "lessthan","24000","1dice7W2AicHosf5EL3GFDUVga7TgtPFn","36.6211","2.670","1.900","98.100","0.0010","250.0000",
  "lessthan","16000","1dice7fUkz5h4z2wPc1wLMPWgB5mDwKDx","24.4141","4.003","1.900","98.100","0.0010","219.6353",
  "lessthan","12000","1dice7EYzJag7SxkdKXLr8Jn14WUb3Cf1","18.3105","5.335","1.900","98.100","0.0010","152.1241",
  "lessthan","8000","1dice6YgEVBf88erBFra9BHf6ZMoyvG88","12.2070","8.000","1.900","98.100","0.0010","120.9568",
  "lessthan","6000","1dice6wBxymYi3t94heUAG6MpG5eceLG1","9.1553","10.666","1.900","98.100","0.0010","120.9090",
  "lessthan","4000","1dice6GV5Rz2iaifPvX7RMjfhaNPC8SXH","6.1035","15.996","1.900","98.100","0.0010","77.9318",
  "lessthan","3000","1dice6gJgPDYz8PLQyJb8cgPBnmWqCSuF","4.5776","21.326","1.900","98.100","0.0010","57.4951",
  "lessthan","2000","1dice6DPtUMBpWgv8i4pG8HMjXv9qDJWN","3.0518","31.987","1.900","98.100","0.0010","59.3926",
  "lessthan","1500","1dice61SNWEKWdA8LN6G44ewsiQfuCvge","2.2888","42.647","1.900","98.100","0.0010","44.1897",
  "lessthan","1000","1dice5wwEZT2u6ESAdUGG6MHgCpbQqZiy","1.5259","63.968","1.900","98.100","0.0010","29.2270",
  "lessthan","512","1dice4J1mFEvVuFqD14HzdViHFGi9h4Pp","0.7813","124.933","1.900","98.100","0.0010","14.8497",
  "lessthan","256","1dice3jkpTvevsohA4Np1yP4uKzG1SRLv","0.3906","249.861","1.900","98.100","0.0010","7.3951",
  "lessthan","128","1dice37EemX64oHssTreXEFT3DXtZxVXK","0.1953","499.717","1.900","98.100","0.0010","3.6902",
  "lessthan","64","1dice2zdoxQHpGRNaAWiqbK82FQhr4fb5","0.0977","999.429","1.900","98.100","0.0010","3.2050",
  "lessthan","32","1dice2xkjAAiphomEJA5NoowpuJ18HT1s","0.0488","1998.853","1.900","98.100","0.0010","1.6017",
  "lessthan","16","1dice2WmRTLf1dEk4HH3Xs8LDuXzaHEQU","0.0244","3997.701","1.900","98.100","0.0010","0.8006",
  "lessthan","8","1dice2vQoUkQwDMbfDACM1xz6svEXdhYb","0.0122","7995.397","1.900","98.100","0.0010","0.4002",
  "lessthan","4","1dice2pxmRZrtqBVzixvWnxsMa7wN2GCK","0.0061","15990.789","1.900","98.100","0.0010","0.2001",
  "lessthan","2","1dice1Qf4Br5EYjj9rnHWqgMVYnQWehYG","0.0031","31981.573","1.900","98.100","0.0010","0.1000",
  "lessthan","1","1dice1e6pdhLzzWQq7yMidf6j8eAg7pkY","0.0015","64000.000","1.844","98.156","0.0010","0.0500") %>%
  matrix(ncol = 9, byrow = T, dimnames = list(NULL,c("Name","Name2","Address","pwin","odds","House cut (%)","Expected return (%)","Min bet (BTC)","Max bet (BTC)"))) %>%
  as_tibble() %>%
  select(odds,pwin) %>%
  type_convert()

extractAndPrepareUser <- function(x,...){
  ret <- x %>%
    arrange(time_bet) %>% 
    normalizeToBitcoin() %>% 
    addlag() %>% 
    aggregateUser() %>% 
    left_join(pwin_to_prob, by = "odds") %>%
    mutate(bet_changed = bet_pred != bet_value,
           game_changed = game_pred != odds,
           risk_increased = game_pred > odds,
           exp_changed = bet_pred*game_pred != bet_value*odds,
           bet_changed_factor = sign(bet_value-bet_pred) %>% factor(levels = c(0,1,-1)),
           game_changed_factor = sign(game_pred-odds) %>% factor(levels = c(0,1,-1)),
           exp_changed_factor = sign(bet_pred*game_pred - bet_value*odds) %>% factor(levels = c(0,1,-1)),
           expectation = bet_pred*game_pred,
           exp_change_ratio = log(bet_pred*game_pred/(bet_value*odds)),
           bet_change_ratio = log(bet_pred/bet_value),
           win_cumm_log = log10(1+abs(winsum)),
           loose_cumm_log = log10(1+abs(loosesum)),
           balance_log = log10(1+abs(balance)),
           balance_sign = as.character(sign(balance)),
           streak = 0,
           difftime = time_nextbet - time_bet,
           stayed = !((time_nextbet - time_bet) > 4*3600) & (timediff < 3600),
           stay_length = 1,
           game_streak = 0,
           streak_total_length = 0) %>%
    left_join(pwin_to_prob %>% rename(pwin_pred = pwin), by = c("game_pred" = "odds")) %>%
    mutate(game_diff = pwin_pred - pwin,
           game_diff_ratio = (pwin_pred - pwin)/pwin) %>%
    drop_na()

  
  for(i in 1:nrow(ret)){
    if(i == 1){
      ret$streak[i] = 0
      ret$stay_length[i] = 1
      ret$game_streak[i] = 0
      ret$risk_lowhold_streak[i] = 0
    }else{ 
      #win streak
      if(ret$status[i] == ret$status[i-1]){
        ret$streak[i] = ret$streak[i-1]+1
      }else{
        ret$streak[i] = 0
      }
      #stay length 
      if(ret$stayed[i]){
        ret$stay_length[i] = ret$stay_length[i-1]+1
      }else{
        ret$stay_length[i] = 1
      }
      #game streak 
      if(!ret$game_changed[i]){
        ret$game_streak[i] = ret$game_streak[i-1]+1
      }else{
        ret$game_streak[i] = 0
      }
      #game streak 
      if(!ret$risk_lowhold_streak[i]){
        ret$risk_lowhold_streak[i] = ret$risk_lowhold_streak[i-1]+1
      }else{
        ret$risk_lowhold_streak[i] = 0
      }
    }
  }
  
  for(i in nrow(ret):1){
    if(i == nrow(ret)){
      ret$streak_total_length[i] = ret$streak[i]
      streak_total_length = ret$streak[i]
    }else{
      if(streak_total_length & ret$streak[i]){
        ret$streak_total_length[i] = streak_total_length
      }else if(streak_total_length & !ret$streak[i]){
        ret$streak_total_length[i] = streak_total_length
        streak_total_length = 0
      }else if(!streak_total_length & ret$streak[i]){
        streak_total_length = ret$streak[i]
        ret$streak_total_length[i] = streak_total_length
      }else{
        ret$streak_total_length[i] = streak_total_length
      }
    }
  }
  return(ret %>% arrange(time_bet))
}

prepare_user_table <- function(user_bets_matched, min_games = 2, ...){
  user_bets_matched %>% 
    drop_na() %>%
    group_by(userID) %>% 
    mutate(ngamez = n()) %>% 
    filter(ngamez > min_games) %>%
    group_modify(extractAndPrepareUser) %>%
    ungroup()
}

#loading and processing data
setwd(WORKDIR)
user_bets_matched_list <- tibble(
  label = c("A","B","C","D","E"),
  start_date = c("2012-05-02", "2012-09-17", "2012-12-17", "2013-05-04", "2013-09-11"),
  end_date = c("2012-05-22", "2012-10-07", "2013-01-06", "2013-05-24", "2013-10-01")) %>%
  mutate(user_bets_matched = map2(start_date, end_date, function(x,y)read.csv(file = paste0("calcdata/satoshidice_bets_matched__",x,"_to_",y,"_clean.csv")))) %>%
  mutate(users_table = map(user_bets_matched, prepare_user_table))

pooled_table_unscaled <- user_bets_matched_list  %>% 
  pull(users_table, name = label) %>%
  bind_rows(.id = "label")
```

# Distribution of win probability

The two tables calculated below are featured in Table 1 and 2. Straightforward summary statistics.

```{r}
pooled_table_unscaled %>%
  group_by(label) %>%
  summarize(
    start_date = as.Date(as.POSIXct(min(time_bet), origin="1970-01-01")),
    n_games = n(),
    n_users = n_distinct(userID),
    tot_bet = sum(bet_value),
    med_bet = median(bet_value),
    .groups = "drop")

#bitcoin prices can be added from the bitcoin_pricehistory_lowvar.R script


pooled_table_unscaled %>%
  group_by(label, pwin) %>%
  summarize(n = n(), .groups = "drop") %>%
  pivot_wider(names_from = label, values_from = n) %>%
  mutate(A = A/sum(A, na.rm = TRUE)*100 %>% round(digits = 1)) %>% 
  mutate(B = B/sum(B, na.rm = TRUE)*100 %>% round(digits = 1)) %>%
  mutate(C = C/sum(C, na.rm = TRUE)*100 %>% round(digits = 1)) %>%
  mutate(D = D/sum(D, na.rm = TRUE)*100 %>% round(digits = 1)) %>%
  mutate(E = E/sum(E, na.rm = TRUE)*100 %>% round(digits = 1)) %>%
  arrange(pwin)
```

# Observed mean winning probability

On streak of n means the game followed n-1 games without changing the outcome at any. Off streak of n means the game has followed n-1 games of any but the same outcomes as the current one. Here we calculate the ratio of wins to losses following game histories on/off streak of n. The plot produces figure 2.

```{r}
winstreak_obs_winprob <- lapply(seq(1,10), function(i){
  pooled_table_unscaled %>% 
  mutate(winstreak = ((status == "win")&(streak == i))) %>%
  group_by(winstreak, label) %>%
  summarize(nof = n(), obs_pwin = sum(status_pred == "win")/n(), .groups = "drop") %>%
  mutate(streak = i) %>%
  group_by(label) %>%
  mutate(n_normed = nof/sum(nof))}) %>%
  bind_rows() %>%
  mutate(winstreak = ifelse(winstreak, "On streak", "Off streak"))

in_win_plot <- ggplot(winstreak_obs_winprob, aes(x=streak, y=obs_pwin, group=interaction(winstreak, label))) +
  geom_line(aes(color = label, linetype = label), size = 1)+
  geom_point(aes(shape = winstreak), size = 2.2) +
    theme_light() +
    theme(
      axis.title.x = element_text(colour="black", size = 13),
      axis.title.y = element_text(colour="black", size = 13),
      axis.text.y = element_text(size = 12),
      axis.text.x = element_text(size = 12),
      legend.position =  "bottom",
      legend.direction = "horizontal",
      legend.text = element_text(colour="black", size = 12),
      legend.title = element_text(colour="black", size = 14),
      line = element_line(size = 2.5, lineend = "butt"),
      legend.key.size = grid::unit(2, "lines"),
      legend.key.width = unit(2,"cm")
    )  +
    scale_color_manual(values = c("#E7033C","#096773","#F9CC2C","#13C062","#111460")) +
    scale_linetype_manual(values = c(1,3,2,4,5)) +
    scale_shape_manual(values=c(25, 24))+
    scale_y_continuous(labels=scales::percent_format(), limits = c(.1,.9)) +
    labs(
      x = "Winning streak length",
      y = "Observed mean winning probability",
      color = "Sample:",
      linetype = "Sample:",
      shape = "Streak type:") + 
  guides(colour = guide_legend(order = 1), 
          shape = guide_legend(order = 2),
          linetype = guide_legend(order = 1)) + 
  xlim(c(0.9,6.1))

lossstreak_obs_winprob <- lapply(seq(1,10), function(i){
  pooled_table_unscaled %>% 
  mutate(lossstreak = ((status == "loss")&(streak == i))) %>%
  group_by(lossstreak, label) %>%
  summarize(n = n(), obs_pwin = sum(status_pred == "win")/n(), .groups = "drop") %>%
  mutate(streak = i)
}) %>%
  bind_rows() %>%
  mutate(lossstreak = ifelse(lossstreak, "On streak", "Off streak"))

in_loss_plot <- ggplot(lossstreak_obs_winprob, aes(x=streak, y=obs_pwin, group=interaction(lossstreak, label))) +
  geom_line(aes(color = label, linetype = label), size = 1)+
  geom_point(aes(shape = lossstreak), size = 2.2) +
    theme_light() +
    theme(
      axis.title.x = element_text(colour="black", size = 13),
      axis.title.y = element_text(colour="black", size = 13),
      axis.text.y = element_text(size = 12),
      axis.text.x = element_text(size = 12),
      legend.position =  "bottom",
      legend.direction = "horizontal",
      legend.text = element_text(colour="black", size = 12),
      legend.title = element_text(colour="black", size = 14),
      line = element_line(size = 2.5, lineend = "butt"),
      legend.key.size = grid::unit(2, "lines"),
      legend.key.width = unit(2,"cm")
    )  +
    scale_color_manual(values = c("#E7033C","#096773","#F9CC2C","#13C062","#111460")) +
    scale_linetype_manual(values = c(1,3,2,4,5)) +
    scale_shape_manual(values=c(25, 24))+
    scale_y_continuous(labels=scales::percent_format(), limits = c(.1,.9)) +
    labs(
      x = "Losing streak length",
      y = "Observed mean winning probability",
      color = "Sample:",
      linetype = "Sample:",
      shape = "Streak type:") + 
  xlim(c(0.9,6.1))

ggpubr::ggarrange(in_win_plot, in_loss_plot, 
                  ncol = 2, nrow = 1,  common.legend = TRUE, legend="bottom")

setwd(WORKDIR)
ggsave("plots/figure_2_2.2.pdf", device = "pdf", width = 36.52,  height = 12.63,  units = "cm")
```

# Mean pwin after streak

Similar to what we have observed before, but here we are measuring the median of the pwin, which is the implied probability of win (reciprocate of odds/multiplier) after an n long win/loss streak. The plot produces figure 3.

```{r}
streak_odds_pwin <- pooled_table_unscaled %>% 
  group_by(status, streak, label) %>%
  summarize(n = n(),
            mean_pwin = mean(pwin_pred),  median_pwin = median(pwin_pred),
            .groups = "drop") %>% filter(streak < 7) %>%
  mutate(status = ifelse(status == "win","Win","Loss"))

ggplot(streak_odds_pwin, aes(x=streak, y=mean_pwin/100, group=interaction(status, label))) +
  geom_line(aes(color = label, linetype = label), size = 1)+
  geom_point(aes(shape = status), size = 2.2) +
    theme_light() +
    theme(
      axis.title.x = element_text(colour="black", size = 13),
      axis.title.y = element_text(colour="black", size = 13),
      axis.text.y = element_text(size = 12),
      axis.text.x = element_text(size = 12),
      legend.position =  "right",
      legend.direction = "vertical",
      legend.text = element_text(colour="black", size = 12),
      legend.title = element_text(colour="black", size = 14),
      line = element_line(size = 2.5, lineend = "butt"),
      legend.key.size = grid::unit(2, "lines"),
      legend.key.width = unit(2,"cm")
    )  +
    scale_color_manual(values = c("#E7033C","#096773","#F9CC2C","#13C062","#111460")) +
    scale_linetype_manual(values = c(1,3,2,4,5)) +
    scale_shape_manual(values=c(25, 24))+
    scale_y_continuous(labels=scales::percent_format(), limits = c(.15,.85)) +
    labs(
      x = "Streak length",
      y = "Mean implied winning probability",
      color = "Sample:",
      linetype = "Sample:",
      shape = "Streak type:") + 
  guides(colour = guide_legend(order = 1), 
          shape = guide_legend(order = 2),
          linetype = guide_legend(order = 1)) +
  xlim(c(0,6.1))

setwd(WORKDIR)
ggsave("plots/figure_3_2.1.pdf", device = "pdf", width = 18.26,  height = 12.63,  units = "cm")
```

# Probability of changing pwin

Here we calculate the ratio of when the game changes (vs when it is not) following win/loss streaks of n. Produces figure 4.

```{r}
pwin_change_prob <- pooled_table_unscaled %>%
  filter(streak <7) %>%
  mutate(status = ifelse(status == "loss", "Loss", "Win")) %>%
  group_by(streak, status) %>%
  summarize(no_change_prob = sum(!game_changed)/n(), 
            change_risk_increased = sum(risk_increased)/n(),
            change_risk_decreased = sum(game_changed&(!risk_increased))/n(),
            .groups = "drop"
            ) %>%
  pivot_longer(cols = c("no_change_prob","change_risk_increased","change_risk_decreased"),
               names_to = "delta")%>%
  mutate(delta = ifelse(delta == "no_change_prob", "No change", ifelse(delta == "change_risk_increased", "Risk increase", "Risk decrease"))) %>%
  mutate(delta = factor(delta, levels = c("Risk increase", "No change", "Risk decrease")))
  

changeprob_win_plot <-  ggplot(pwin_change_prob %>% filter(status == "Win"), 
                               aes(fill=delta, y=value, x=streak)) +
  geom_col(position = "fill") + 
  theme_light() +
  geom_text(aes(label = floor(value*100)),position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values = c("#E7033C","#096773","#13C062","#F9CC2C","#111460")) +
  theme(
    axis.title.x = element_text(colour="black", size = 13),
    axis.title.y = element_text(colour="black", size = 13),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    legend.position =  "right",
    legend.direction = "horizontal",
    legend.spacing.x = unit(.8, 'cm'),
    legend.text = element_text(colour="black", size = 12),
    legend.title = element_text(colour="black", size = 14),
    line = element_line(size = 2.5, lineend = "butt"),
    legend.key.size = grid::unit(4, "lines"),
    legend.key.width = unit(.8,"cm"),
    legend.key.height = unit(1,"cm"),
    strip.text.y = element_text(
        size = 13, color = "white", face = "bold"
        )
  )+ 
  scale_y_continuous(labels=scales::percent_format(accuracy = 5L)) +
  labs(
    x = "Streak length (win)",
    y = "Probability of change in game",
    fill = "Change in risk taken:")

changeprob_loss_plot <-  ggplot(pwin_change_prob %>% filter(status == "Loss"), 
                               aes(fill=delta, y=value, x=streak)) +
  geom_col(position = "fill") + 
  theme_light() +
  geom_text(aes(label = floor(value*100)),position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values = c("#E7033C","#096773","#13C062","#F9CC2C","#111460")) +
  theme(
    axis.title.x = element_text(colour="black", size = 13),
    axis.title.y = element_text(colour="black", size = 13),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    legend.position =  "right",
    legend.direction = "horizontal",
    legend.spacing.x = unit(.8, 'cm'),
    legend.text = element_text(colour="black", size = 12),
    legend.title = element_text(colour="black", size = 14),
    line = element_line(size = 2.5, lineend = "butt"),
    legend.key.size = grid::unit(4, "lines"),
    legend.key.width = unit(.8,"cm"),
    legend.key.height = unit(1,"cm"),
    strip.text.y = element_text(
        size = 13, color = "white", face = "bold"
        )
  )+ 
  scale_y_continuous(labels=scales::percent_format(accuracy = 5L)) +
  labs(
    x = "Streak length (loss)",
    y = "Probability of change in game",
    fill = "Change in risk taken:")

ggpubr::ggarrange(changeprob_win_plot, changeprob_loss_plot, 
                  ncol = 2, nrow = 1,  common.legend = TRUE, legend="bottom")

setwd(WORKDIR)

ggsave("plots/figure_4_5.1.pdf", device = "pdf", width = 36.52,  height = 12.63,  units = "cm")
```
# Size of pwin change

Here we calculate the relative size of change in pwin. Here -1 means halving pwin compared to the current game (e.g. from 50% to 25%) and +1 means doubling it (e.g. from 1% to 2%). Logarithmic scale is used to normalise the distribution of the ratios, a well known technique from finance. This section produces figure 5.

```{r}
pwin_change_relative <- pooled_table_unscaled %>% 
  filter((streak < 7) & game_changed) %>%
  mutate(streak_signed = ifelse(status == "win",streak,-streak)) %>%
  group_by(streak_signed, label) %>%
  summarize(
    game_diff_mean = mean(game_diff_ratio+1), 
    game_diff_logmean = mean(log(game_diff_ratio+1, base = 2)), 
    game_diff_median = median(game_diff_ratio+1), 
            .groups = "drop")

dset_change_relative <- pooled_table_unscaled %>% 
  filter((streak < 7) & game_changed) %>%
  mutate(streak_signed = ifelse(status == "win",streak,-streak)) %>%
  mutate(game_diff_ratio_log = log(game_diff_ratio+1, base = 2)) %>%
  select(streak_signed, label, game_diff_ratio_log)

logmean <- function(data, i){
  mean(data[i])
}

p_level <- .01 #that is 1%

pwin_change_relative_boot <- dset_change_relative %>%
  group_by(streak_signed, label) %>%
  group_modify(
    function(.x,...){
    bootout <- boot::boot(.x$game_diff_ratio_log, 
             logmean, 
             R = 10000
    )
    return(
      tibble(
        logmean = mean(.x$game_diff_ratio_log),
        bottom = quantile(bootout$t, p_level/2),
        top = quantile(bootout$t, 1-p_level/2)
        )
      )
    }
  )

pwin_change_relative_boot %>%
  {ggplot(data = ., aes(x = factor(streak_signed), y = logmean, group = label)) +
  geom_point(aes(color = label, shape = label), size = 4)+
  geom_errorbar(aes(ymin = top, ymax = bottom, color = label), position = position_dodge(0.1)) +
  geom_hline(yintercept = 0) + 
  geom_vline(xintercept = which(levels(factor(.$streak_signed)) %in% '0')) +
    theme_light() +
    theme(
      axis.title.x = element_text(colour="black", size = 13),
      axis.title.y = element_text(colour="black", size = 13),
      axis.text.y = element_text(size = 12),
      axis.text.x = element_text(size = 12),
      legend.position =  "right",
      legend.direction = "vertical",
      legend.text = element_text(colour="black", size = 12),
      legend.title = element_text(colour="black", size = 14),
      line = element_line(size = 2.5, lineend = "butt"),
      legend.key.size = grid::unit(2, "lines"),
      legend.key.width = unit(1,"cm")
    )  +
    scale_color_manual(values = c("#F9CC2C","#096773","#E7033C","#13C062","#111460")) +
    scale_shape_manual(values = c(15,16,24,18,25)) +
    #scale_y_continuous(labels = scales::trans_format(function(x)2^x, scales::math_format(.x))) +
    labs(
      x = "losing                   Streak                 winning",
      y = "Mean log relative change in winning probabilities",
      color = "Sample:",
      shape = "Sample:")}

setwd(WORKDIR)
ggsave("plots/figure_5_3.2.pdf", device = "pdf", width = 18.26,  height = 12.63,  units = "cm")
```

# Simulations

Here we are basically generating random sequences of outcomes for players who choose a random game from their initial set and stuck to it for n_games. Then we calculate the same observed winning probabilites Xu and Harwey worked with and plot it like we did for the data in the beginning. It produces figure 1.

```{r}
n_players <- 10000
n_games <- 100
#non-changing bots with uniform distribution of initial risk
sim_games_uniform <- lapply(runif(n_players), function(x)({
  rolls <- tibble(game = x, status = ifelse(runif(n_games) < x,"win","loss"), streak = 0)
  for(i in seq(1, n_games)){
    if(i == 1){
      rolls$streak = 0
    }else{ 
      #win streak
      if(rolls$status[i] == rolls$status[i-1]){
        rolls$streak[i] = rolls$streak[i-1]+1
      }else{
        rolls$streak[i] = 0
      }
    }
  }
  return(rolls)})) %>%
  bind_rows() %>% 
  mutate(status_pred = lead(status, n = 1)) %>% 
  drop_na()
winstreak_obs_winprob_uniform <- lapply(seq(1,10), function(i){
  sim_games_uniform %>% 
  mutate(winstreak = ((status == "win")&(streak == i))) %>%
  group_by(winstreak) %>%
  summarize(n = n(), obs_pwin = sum(status_pred == "win")/n(), .groups = "drop") %>%
  mutate(streak = i)
}) %>%
  bind_rows() %>%
  mutate(winstreak = ifelse(winstreak, "In win streak", "Off win streak"))
losingstreak_obs_winprob_uniform <- lapply(seq(1,10), function(i){
  sim_games_uniform %>% 
  mutate(lossstreak = ((status == "loss")&(streak == i))) %>%
  group_by(lossstreak) %>%
  summarize(n = n(), obs_pwin = sum(status_pred == "win")/n(), .groups = "drop") %>%
  mutate(streak = i)
}) %>%
  bind_rows() %>%
  mutate(lossstreak = ifelse(lossstreak, "In loss streak", "Off loss streak"))
#non-changing bots with initial risk distribution matching the distribution of the dataset
players_satoshi <- pooled_table_unscaled %>% 
  pull(pwin) %>% 
  table() %>% 
  {setNames(as.vector(.)/sum(.)*n_players,names(.))}  %>% 
  round() %>% 
  {mapply(function(x, i) rep(i, x), ., names(.))} %>%
  unlist() %>%
  as.numeric()/100
sim_games_satoshi <- lapply(players_satoshi, function(x)({
  rolls <- tibble(game = x, status = ifelse(runif(n_games) < x,"win","loss"), streak = 0)
  for(i in seq(1, n_games)){
    if(i == 1){
      rolls$streak = 0
    }else{ 
      #win streak
      if(rolls$status[i] == rolls$status[i-1]){
        rolls$streak[i] = rolls$streak[i-1]+1
      }else{
        rolls$streak[i] = 0
      }
    }
  }
  return(rolls)})) %>%
  bind_rows() %>% 
  mutate(status_pred = lead(status, n = 1)) %>% 
  drop_na()
winstreak_obs_winprob_satoshi <- lapply(seq(1,10), function(i){
  sim_games_satoshi %>% 
  mutate(winstreak = ((status == "win")&(streak == i))) %>%
  group_by(winstreak) %>%
  summarize(n = n(), obs_pwin = sum(status_pred == "win")/n(), .groups = "drop") %>%
  mutate(streak = i)
}) %>%
  bind_rows() %>%
  mutate(winstreak = ifelse(winstreak, "In win streak", "Off win streak"))
losingstreak_obs_winprob_satoshi <- lapply(seq(1,10), function(i){
  sim_games_satoshi %>% 
  mutate(lossstreak = ((status == "loss")&(streak == i))) %>%
  group_by(lossstreak) %>%
  summarize(n = n(), obs_pwin = sum(status_pred == "win")/n(), .groups = "drop") %>%
  mutate(streak = i)
}) %>%
  bind_rows() %>%
  mutate(lossstreak = ifelse(lossstreak, "In loss streak", "Off loss streak"))
#non-changing bots with initial risk distribution consisting of two levels of 25% and 75%
players_twogames <- c(rep(.75,n_players/2), rep(.25,n_players/2))
sim_games_twogames <- lapply(players_twogames, function(x)({
  rolls <- tibble(game = x, status = ifelse(runif(n_games) < x,"win","loss"), streak = 0)
  for(i in seq(1, n_games)){
    if(i == 1){
      rolls$streak = 0
    }else{ 
      #win streak
      if(rolls$status[i] == rolls$status[i-1]){
        rolls$streak[i] = rolls$streak[i-1]+1
      }else{
        rolls$streak[i] = 0
      }
    }
  }
  return(rolls)})) %>%
  bind_rows() %>% 
  mutate(status_pred = lead(status, n = 1)) %>% 
  drop_na()
winstreak_obs_winprob_twogames <- lapply(seq(1,10), function(i){
  sim_games_twogames %>% 
  mutate(winstreak = ((status == "win")&(streak == i))) %>%
  group_by(winstreak) %>%
  summarize(n = n(), obs_pwin = sum(status_pred == "win")/n(), .groups = "drop") %>%
  mutate(streak = i)
}) %>%
  bind_rows() %>%
  mutate(winstreak = ifelse(winstreak, "In win streak", "Off win streak"))
losingstreak_obs_winprob_twogames <- lapply(seq(1,10), function(i){
  sim_games_twogames %>% 
  mutate(lossstreak = ((status == "loss")&(streak == i))) %>%
  group_by(lossstreak) %>%
  summarize(n = n(), obs_pwin = sum(status_pred == "win")/n(), .groups = "drop") %>%
  mutate(streak = i)
}) %>%
  bind_rows() %>%
  mutate(lossstreak = ifelse(lossstreak, "In loss streak", "Off loss streak"))
#Combining simulations
winstreak_obs_winprob_combined <- winstreak_obs_winprob_uniform %>% mutate(riskdist = "Uniform") %>%
  bind_rows(winstreak_obs_winprob_satoshi %>% mutate(riskdist = "Satoshi")) %>%
  bind_rows(winstreak_obs_winprob_twogames %>% mutate(riskdist = "Binary"))
losingstreak_obs_winprob_combined <- losingstreak_obs_winprob_uniform %>% mutate(riskdist = "Uniform") %>%
  bind_rows(losingstreak_obs_winprob_satoshi %>% mutate(riskdist = "Satoshi")) %>%
  bind_rows(losingstreak_obs_winprob_twogames %>% mutate(riskdist = "Binary"))
#Creating plot
simu_win <- ggplot(winstreak_obs_winprob_combined %>%
                     mutate(winstreak = ifelse(winstreak == "Off win streak","Off streak","On streak")), 
                   aes(x=streak, y=obs_pwin, group=interaction(winstreak, riskdist))) +
  geom_line(aes(color = riskdist, linetype = riskdist), size = 1)+
  geom_point(aes(shape = winstreak), size = 1.5) +
    theme_light() +
    theme(
      axis.title.x = element_text(colour="black", size = 13),
      axis.title.y = element_text(colour="black", size = 13),
      axis.text.y = element_text(size = 12),
      axis.text.x = element_text(size = 12),
      legend.position =  "right",
      legend.direction = "vertical",
      legend.text = element_text(colour="black", size = 12),
      legend.title = element_text(colour="black", size = 14),
      line = element_line(size = 2.5, lineend = "butt"),
      legend.key.size = grid::unit(2, "lines"),
      legend.key.width = unit(2,"cm")
    )  +
    scale_color_manual(values = c("#F9CC2C","#E7033C","#096773","#13C062","#111460")) +
    scale_linetype_manual(values = c(1,3,2)) +
    scale_shape_manual(values=c(25, 24))+
    scale_y_continuous(labels=scales::percent_format(), limits = c(.15,.85)) +
    labs(
      x = "Winning streak length",
      y = "Measured mean winning probability",
      color = "Risk distribution:",
      linetype = "Risk distribution:",
      shape = "Streak type:") + 
  guides(colour = guide_legend(order = 1), 
          shape = guide_legend(order = 2),
          linetype = guide_legend(order = 1)) + 
  xlim(c(0.9,6.1))
simu_loss <- ggplot(losingstreak_obs_winprob_combined %>%
                     mutate(lossstreak = ifelse(lossstreak == "Off loss streak","Off streak","On streak")), 
                    aes(x=streak, y=obs_pwin, group=interaction(lossstreak, riskdist))) +
  geom_line(aes(color = riskdist, linetype = riskdist), size = 1)+
  geom_point(aes(shape = lossstreak), size = 2.2) +
    theme_light() +
    theme(
      axis.title.x = element_text(colour="black", size = 13),
      axis.title.y = element_text(colour="black", size = 13),
      axis.text.y = element_text(size = 12),
      axis.text.x = element_text(size = 12),
      legend.position =  "bottom",
      legend.direction = "horizontal",
      legend.text = element_text(colour="black", size = 12),
      legend.title = element_text(colour="black", size = 14),
      line = element_line(size = 2.5, lineend = "butt"),
      legend.key.size = grid::unit(2, "lines"),
      legend.key.width = unit(2,"cm")
    )  +
    scale_color_manual(values = c("#F9CC2C","#E7033C","#096773","#13C062","#111460")) +
    scale_linetype_manual(values = c(1,3,2)) +
    scale_shape_manual(values=c(25, 24))+
    scale_y_continuous(labels=scales::percent_format(), limits = c(.15,.85)) +
    labs(
      x = "Losing streak length",
      y = "Measured mean winning probability",
      color = "Risk distribution:",
      linetype = "Risk distribution:",
      shape = "Streak type:") + 
  guides(colour = guide_legend(order = 1), 
          shape = guide_legend(order = 2),
          linetype = guide_legend(order = 1)) + 
  xlim(c(0.9,6.1))
ggpubr::ggarrange(simu_win, simu_loss,
          ncol = 2, nrow = 1,  common.legend = TRUE, legend="bottom")

setwd(WORKDIR)
ggsave("plots/figure_1_2.1.pdf", device = "pdf", width = 36.52,  height = 12.63,  units = "cm")
```

# After win streaks XU ANSWER REPLICATION

Here we have tried to replicate the analysis Xu and Harvey presented as a reaction to the critique of Demaree. They calculate average of user risk propensity, depending on the longest win/loss streaks reached by those users. They first create risk propensities for players, averaging the players' chosen risk probabilites in their games and then averaging over the users, thus weighing the propensity of all users equally. We on the other hand only did the averaging over the games, after assigning them to the maximum streak lengths, thus weighing user propensities by the number of bets placed. The script produces figure 6.

```{r}
#no averaging on user level before aggregation
#this represents the right thing to do
dset_xuanswer_longest_streak_length_signed_nonaggreg <- pooled_table_unscaled %>% 
  select(userID, odds, pwin, streak, streak_total_length, status) %>%
  mutate(streak_total_length_signed = ifelse(status == "win", streak_total_length, -streak_total_length)) %>%
  group_by(userID) %>%
  mutate(streak_max_win = pmax(max(streak_total_length_signed),0),
         streak_max_loss = abs(pmin(min(streak_total_length_signed),0))) %>%
  ungroup() %>%
  {bind_rows(group_by(., streak_max_win) %>%
               summarise(mean_pwin = mean(pwin),
                         mean_multip = mean(odds),
                         n_of = n(),
                         .groups = "drop") %>%
               mutate(status = "win") %>%
               rename(streak_max = streak_max_win),
             group_by(.,streak_max_loss) %>%
               summarise(mean_pwin = mean(pwin),
                         mean_multip = mean(odds),
                         n_of = n(),
                         .groups = "drop") %>%
               mutate(status = "loss") %>%
               rename(streak_max = streak_max_loss))}
ggplot(dset_xuanswer_longest_streak_length_signed_nonaggreg, aes(x=streak_max, y=mean_pwin, group=status)) +
  geom_line(aes(color=status))+
  ggtitle("Mean pwin with vs longest win/loss streak experienced (no averaging for users / our approach)") +
  xlab("Streak length") + 
  ylab("Mean pwin") + 
  labs(group = "Win/loss streak") +
  xlim(0,6)
#creating user averages before aggregation
#this represents the way Xu probably did it
dset_xuanswer_longest_streak_length_signed_useraggr <- pooled_table_unscaled %>% 
  select(userID, odds, pwin, streak, streak_total_length, status) %>%
  mutate(streak_total_length_signed = ifelse(status == "win", streak_total_length, -streak_total_length)) %>%
  group_by(userID) %>%
  summarise(streak_max_win = pmax(max(streak_total_length_signed),0),
         streak_max_loss = abs(pmin(min(streak_total_length_signed),0)),
         user_mean_pwin = mean(pwin),
         user_mean_multip = mean(odds),
         n_games = n(),
         .groups = "drop") %>%
  {bind_rows(group_by(., streak_max_win) %>%
               summarise(mean_pwin = mean(user_mean_pwin),
                         mean_multip = mean(user_mean_multip),
                         n_of = n(),
                         .groups = "drop") %>%
               mutate(status = "win") %>%
               rename(streak_max = streak_max_win),
             group_by(.,streak_max_loss) %>%
               summarise(mean_pwin = mean(user_mean_pwin),
                         mean_multip = mean(user_mean_multip),
                         n_of = n(),
                         .groups = "drop") %>%
               mutate(status = "loss") %>%
               rename(streak_max = streak_max_loss))}
xuanswer_us <- ggplot(dset_xuanswer_longest_streak_length_signed_nonaggreg %>%
                      mutate(status = ifelse(status == "win","Win","Loss")), 
                      aes(x=streak_max, y=mean_pwin/100, group=status)) +
  geom_line(aes(color = status, linetype = status), size = 1)+
  geom_point(aes(color = status, shape = status), size = 1.5) +
    theme_light() +
    theme(
      axis.title.x = element_text(colour="black", size = 13),
      axis.title.y = element_text(colour="black", size = 13),
      axis.text.y = element_text(size = 12),
      axis.text.x = element_text(size = 12),
      legend.position =  "bottom",
      legend.direction = "horizontal",
      legend.text = element_text(colour="black", size = 12),
      legend.title = element_text(colour="black", size = 14),
      line = element_line(size = 2.5, lineend = "butt"),
      legend.key.size = grid::unit(2, "lines"),
      legend.key.width = unit(2,"cm")
    )  +
    scale_color_manual(values = c("#E7033C","#13C062","#096773","#F9CC2C","#111460")) +
    scale_linetype_manual(values = c(1,3,2,4,5)) +
    scale_shape_manual(values=c(25, 24))+
    scale_y_continuous(labels=scales::percent_format()) +
    labs(
      x = "Longest streak achieved by player",
      y = "Mean winning probability (games)",
      color = "Streak type",
      linetype = "Streak type",
      shape = "Streak type") + 
  xlim(0,6)
xuanswer_them <- ggplot(dset_xuanswer_longest_streak_length_signed_useraggr%>%
                      mutate(status = ifelse(status == "win","Win","Loss")),
                      aes(x=streak_max, y=mean_pwin/100, group=status)) +
  geom_line(aes(color = status, linetype = status), size = 1)+
  geom_point(aes(color = status, shape = status), size = 1.5) +
    theme_light() +
    theme(
      axis.title.x = element_text(colour="black", size = 13),
      axis.title.y = element_text(colour="black", size = 13),
      axis.text.y = element_text(size = 12),
      axis.text.x = element_text(size = 12),
      legend.position =  "bottom",
      legend.direction = "horizontal",
      legend.text = element_text(colour="black", size = 12),
      legend.title = element_text(colour="black", size = 14),
      line = element_line(size = 2.5, lineend = "butt"),
      legend.key.size = grid::unit(2, "lines"),
      legend.key.width = unit(2,"cm")
    )  +
    scale_color_manual(values = c("#E7033C","#13C062","#096773","#F9CC2C","#111460")) +
    scale_linetype_manual(values = c(1,3,2,4,5)) +
    scale_shape_manual(values=c(25, 24))+
    scale_y_continuous(labels=scales::percent_format()) +
    labs(
      x = "Longest streak achieved by player",
      y = "Mean winning probability (players)",
      color = "Streak type:",
      linetype = "Streak type:",
      shape = "Streak type:") + 
  xlim(0,6)
ggpubr::ggarrange(xuanswer_them, xuanswer_us,
          ncol = 2, nrow = 1,  common.legend = TRUE, legend="bottom")

setwd(WORKDIR)
ggsave("plots/figure_6_2.0.pdf", device = "pdf", width = 36.52,  height = 12.63,  units = "cm")
```